# 图床后端开发规划

* 接受文件上传 ，推送到 github 仓库中
* 对每个上传的文件进行散列值检测，存储到数据库中，已存在散列值，直接返回已有的文件信息即可
* 文件路径保持唯一，散列值不唯一，因为一个仓库可以存储重复的文件 
* 添加github webhook，监听push事件，更新数据库 
* 初始化机制，利用 github api 读取仓库所有文件，存储到数据库 
* 数据库备份导出机制，也存储到github仓库中，这个备份要有定时任务机制


# 数据库设计

使用 MySQL 作为存储数据库，因为可以远程访问，这点比sqlite有非常大的优势。 	

用户帐号信息表，Github仓库表，文件信息存储表，数据库备份记录表 

```sql
CREATE TABLE pic_users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nickname VARCHAR(255) NULL COMMENT '昵称',
    username VARCHAR(255) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    user_type tinyint(1) unsigned not null default 0 comment '用户类型: 0,普通用户; 1,超级管理员',
    deleted_at TIMESTAMP NULL COMMENT '软删除标记',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
)
ENGINE=InnoDB 
DEFAULT CHARSET=utf8mb4 
COMMENT='图床用户表';

CREATE TABLE pic_repositories (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL COMMENT '仓库所属用户',
    repo_name VARCHAR(255) NOT NULL COMMENT '仓库名称',
    repo_url VARCHAR(255) NOT NULL COMMENT '仓库链接',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE INDEX `idx_user_repo` (`user_id`, `repo_url`)
)
ENGINE=InnoDB 
DEFAULT CHARSET=utf8mb4 
COMMENT='存储仓库表';


CREATE TABLE pic_files (
    id INT AUTO_INCREMENT PRIMARY KEY,
    repo_id INT NOT NULL COMMENT '仓库ID',
    user_id INT NOT NULL COMMENT '仓库和用户',
    filename VARCHAR(200) NOT NULL COMMENT '文件名称',
    url VARCHAR(255) NOT NULL COMMENT '文件路径',
    hash_value VARCHAR(200) NULL COMMENT '文件散列值',
    raw_filename VARCHAR(250) NULL COMMENT '文件上传时的原始名称',
    filesize INT UNSIGNED NULL COMMENT '文件大小，单位bit	',
    width INT UNSIGNED NULL comment '图片宽度',
    height INT UNSIGNED NULL comment '图片高度',
    mime varchar(50) NULL COMMENT '文件类型',
    filetype tinyint(1) UNSIGNED not null default 0 comment '文件类型: 0,未知;1,图片;2,视频;3,音频;4,文本;5,其他',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    index `idx_user_id` (`user_id`),
    index `idx_repo_id` (`repo_id`),
    unique index `url` (`url`)
)
ENGINE=InnoDB 
DEFAULT CHARSET=utf8mb4 
COMMENT='图床文件表';

CREATE TABLE pic_backup_records (
    id INT AUTO_INCREMENT PRIMARY KEY,
    repo_id INT NOT NULL COMMENT '备份仓库ID',
    backup_path VARCHAR(255) NOT NULL,
    backup_date DATE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
ENGINE=InnoDB 
DEFAULT CHARSET=utf8mb4 
COMMENT='图床数据备份记录表';

CREATE TABLE `pic_config` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` INT NOT NULL default 0 comment '用户ID，默认0为系统配置',
  `type` varchar(24) DEFAULT NULL COMMENT '类型',
  `name` varchar(32) NOT NULL COMMENT '名称',
  `value` varchar(500) COMMENT '值',
  `remark` varchar(50) COMMENT '此值标记',
	created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  unique idx_user_key (user_id, type, name)
) 
ENGINE=InnoDB 
DEFAULT CHARSET=utf8mb4
COMMENT='配置表';


INSERT INTO pic_config
(`user_id`, `type`, `name`, `value`, `remark`)
values 
(0, 'pichub', 'github_token', 'xxxxxx', `github授权token`),
(0, 'pichub', 'cdn_domain', 'https://pic.mysticalpower.uk', `cdn加速域名`)
;
```


# 功能模块设计
1. 用户登陆注册模块
   - 注册填写邮件、用户名、昵称、密码
   - 提交注册，发送邮件给用户来激活
   - 登陆成功后，检测是否有添加github token 

2. github 仓库管理模块
   - 允许用户添加github仓库
   - 添加成功过后进行仓库数据初始化 	
   - 或者进行手动初始化处理【允许多次调用	】
   - 使用 GitHub API 读取仓库所有文件。
   - 计算每个文件的散列值，并存储到 `files` 表。

4. **文件上传与散列值检测**
   - 接受文件上传，计算文件的散列值。
   - 接受另外一个参数 is_force，是否强制上传
   - 查询 `files` 表，检查散列值是否存在。
   - 如果存在 且 is_force 为 false，则返回已有文件信息，为true则覆盖上传 
   - 如果不存在，生成唯一文件路径，存储文件信息到数据库，并推送到 GitHub 仓库。

5. **GitHub Webhook 监听**
   - 设置 GitHub Webhook 监听 push 事件。
   - 当仓库有新的提交时，更新 `files` 表中的文件信息。


6. **数据库备份与导出**
   - 定时任务（如使用 `cron`）定期备份数据库。
   - 备份文件存储到 GitHub 仓库中，并记录到 `backup_records` 表。
   



# 邮件发送通知提醒
cloudflare 自定义域名邮箱 https://blog.fishze.com/archives/287

发送注册邮件、忘记密码邮件等等	

